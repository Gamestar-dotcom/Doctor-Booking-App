import{r as l,k as L,l as A,y as p,j as e,b as S,L as C}from"./index-BWlQ3emJ.js";import{a as I,c as z}from"./appointmentAPi-CGa3CNjx.js";const W=({isOpen:j,onClose:a,appointmentDetails:n,onSubmit:u})=>{const[s,b]=l.useState(""),[g,P]=l.useState((n==null?void 0:n.fee)||""),[o,d]=l.useState(""),[y,x]=l.useState(null),[i,m]=l.useState("initiate"),[N,{isLoading:v}]=L(),{data:c}=A(y,{skip:!y,pollingInterval:5e3});l.useEffect(()=>{var t;c&&(c.status==="Completed"?(m("completed"),p.success("Payment completed successfully!"),setTimeout(()=>{u(),a()},2e3)):c.status==="Failed"&&(m("failed"),d(((t=c.paymentRequest)==null?void 0:t.failure_reason)||"Payment failed. Please try again.")))},[c,u,a]);const w=async t=>{var M;if(t.preventDefault(),d(""),!s||s.length<10){d("Please enter a valid phone number");return}let r=s;!s.startsWith("254")&&s.startsWith("0")?r="254"+s.substring(1):s.startsWith("254")||(r="254"+s);const h=Math.floor(g);try{const f=await N({phoneNumber:r,amount:h}).unwrap();if(console.log("Payment Initiation Result:",s,g),f.CheckoutRequestID)x(f.CheckoutRequestID),m("pending"),p.info("Payment initiated. Please check your phone.");else throw new Error("Invalid response from server.")}catch(f){d(((M=f.data)==null?void 0:M.message)||"Payment initiation failed. Please try again."),p.error(o||"Payment initiation failed")}},k=()=>{m("initiate"),x(null),d("")};return j?e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"M-Pesa Payment"}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-gray-500",children:e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"mb-6 text-center",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("svg",{className:"h-12 w-auto text-green-600",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7v-2z"})})}),i==="initiate"&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"You will receive an M-Pesa STK push notification on your phone."}),e.jsx("p",{className:"text-sm text-gray-600",children:"Please enter your PIN when prompted to complete the payment."})]}),i==="pending"&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"flex justify-center mb-3",children:e.jsxs("svg",{className:"animate-spin h-10 w-10 text-green-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),e.jsx("p",{className:"font-medium text-gray-800 mb-2",children:"Waiting for payment confirmation"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Please check your phone and enter your M-Pesa PIN to complete the payment"})]}),i==="completed"&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"flex justify-center mb-3",children:e.jsx("svg",{className:"h-12 w-12 text-green-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M5 13l4 4L19 7"})})}),e.jsx("p",{className:"font-medium text-green-600 mb-2",children:"Payment Successful!"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Your payment has been processed successfully."})]}),i==="failed"&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"flex justify-center mb-3",children:e.jsx("svg",{className:"h-12 w-12 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("p",{className:"font-medium text-red-600 mb-2",children:"Payment Failed"}),e.jsx("p",{className:"text-sm text-gray-600",children:"We couldn't process your payment. Please try again."})]})]}),o&&e.jsx("div",{className:"mb-4 p-2 bg-red-50 border border-red-100 text-red-700 text-sm rounded",children:o}),i==="initiate"&&e.jsxs("form",{onSubmit:w,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone Number"}),e.jsx("input",{type:"tel",placeholder:"e.g. 0712345678",className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",value:s,onChange:t=>b(t.target.value),required:!0}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Enter the phone number registered with M-Pesa"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (KES)"}),e.jsx("input",{type:"number",className:"w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50",value:g,readOnly:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:opacity-50",disabled:v,children:v?e.jsxs("span",{className:"flex items-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Processing..."]}):"Pay Now"})]})]}),i==="pending"&&e.jsx("div",{className:"flex justify-center mt-4",children:e.jsx("button",{onClick:a,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Check Later"})}),i==="failed"&&e.jsxs("div",{className:"flex justify-center space-x-3 mt-4",children:[e.jsx("button",{onClick:k,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500",children:"Try Again"}),e.jsx("button",{onClick:a,className:"px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50",children:"Cancel"})]})]})}):null},R=()=>{const{isAuthenticated:j,user:a}=S(t=>t.auth),[n,u]=l.useState("upcoming"),[s,b]=l.useState(!1),[g,P]=l.useState(null),{data:o,isLoading:d,error:y,refetch:x}=I();l.useEffect(()=>{x()},[o,x]);const[i,{isLoading:m}]=z(),N=async t=>{const r=Number(t);if(isNaN(r)){console.error("Invalid appointment ID:",t),p.error("Failed to cancel appointment. Invalid ID.");return}try{await i(r).unwrap(),p.success("Appointment cancelled successfully!")}catch(h){console.error("Error cancelling appointment:",h),p.error("Failed to cancel appointment. Please try again.")}};if(!j||(a==null?void 0:a.role)!=="patient")return e.jsxs("div",{className:"flex flex-col items-center justify-center h-64 bg-gray-50 rounded-lg shadow-sm",children:[e.jsx("p",{className:"text-lg text-gray-700 mb-4",children:"You must be logged in as a patient to view your appointments."}),e.jsx(C,{to:"/login",className:"px-6 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50",children:"Login"})]});if(d)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"animate-pulse flex space-x-2",children:[e.jsx("div",{className:"h-3 w-3 bg-blue-600 rounded-full"}),e.jsx("div",{className:"h-3 w-3 bg-blue-600 rounded-full"}),e.jsx("div",{className:"h-3 w-3 bg-blue-600 rounded-full"})]})});if(y)return e.jsx("div",{className:"bg-red-50 border-l-4 border-red-500 p-4 my-4 rounded shadow-sm",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsx("div",{className:"ml-3",children:e.jsx("p",{className:"text-sm text-red-700",children:"Failed to load your appointments. Please try again later."})})]})});const c=(()=>{if(!o||o.length===0)return[];const t=new Date;return o.filter(r=>{const h=new Date(r.appointment_date);return n==="upcoming"?h>=t&&r.status!=="cancelled":n==="past"?h<t||r.status==="completed":n==="cancelled"?r.status==="cancelled":!0})})(),w=t=>{switch(t){case"confirmed":return"bg-green-100 text-green-800 border-green-200";case"pending":return"bg-yellow-100 text-yellow-800 border-yellow-200";case"cancelled":return"bg-red-100 text-red-800 border-red-200";case"completed":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-gray-100 text-gray-800 border-gray-200"}},k=t=>{const r=new Date(t);return new Intl.DateTimeFormat("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(r)};return e.jsxs("div",{className:"max-w-4xl mx-auto mt-6 px-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-800",children:"My Appointments"}),e.jsx(C,{to:"/doctors",className:"px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors",children:"Book New Appointment"})]}),o.some(t=>t.status==="pending")&&e.jsxs("div",{className:"mb-4 text-gray-600",children:["Hey ",e.jsx("span",{className:"font-semibold text-black",children:a.name}),", always come back to check the status of your appointments is complete after a successful payment."]}),e.jsx("div",{className:"mb-6 border-b border-gray-200",children:e.jsxs("nav",{className:"flex space-x-8",children:[e.jsx("button",{className:`py-4 px-1 border-b-2 font-medium text-sm ${n==="upcoming"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,onClick:()=>u("upcoming"),children:"Upcoming"}),e.jsx("button",{className:`py-4 px-1 border-b-2 font-medium text-sm ${n==="past"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,onClick:()=>u("past"),children:"Past"}),e.jsx("button",{className:`py-4 px-1 border-b-2 font-medium text-sm ${n==="cancelled"?"border-blue-500 text-blue-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,onClick:()=>u("cancelled"),children:"Cancelled"})]})}),c.length===0?e.jsxs("div",{className:"bg-gray-50 rounded-lg p-8 text-center",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No appointments"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:n==="upcoming"?"You don't have any upcoming appointments. Check your status for recent bookings in the Past tab":n==="past"?"You don't have any past appointments.":"You don't have any cancelled appointments."})]}):e.jsx("div",{className:"space-y-4",children:c.map(t=>e.jsx("div",{className:"bg-white shadow-sm border border-gray-200 rounded-lg p-5 transition-all hover:shadow-md",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between",children:[e.jsxs("div",{className:"md:w-2/3",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx("svg",{className:"h-5 w-5 text-blue-500 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Dr. ",t.doctor_name]})]}),e.jsxs("div",{className:"flex items-center mb-2 text-gray-600",children:[e.jsx("svg",{className:"h-5 w-5 text-gray-400 mr-2",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),e.jsx("span",{children:k(t.appointment_date)})]}),t.reason&&e.jsxs("p",{className:"text-gray-500 mb-3",children:[e.jsx("span",{className:"font-medium",children:"Reason:"})," ",t.reason]}),e.jsx("div",{className:"mb-3 md:mb-0",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${w(t.status)}`,children:t.status})})]}),e.jsxs("div",{className:"flex flex-col space-y-2 md:items-end mt-4 md:mt-0",children:[e.jsx(C,{to:`/appointments/${t.appointment_id}`,className:"inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 w-full md:w-auto text-center",children:"View Details"}),t.status==="pending"&&e.jsx("button",{onClick:()=>N(t.appointment_id),className:"inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed",disabled:m,children:m?"Cancelling...":"Cancel"}),t.status==="confirmed"&&e.jsx("button",{onClick:()=>{P(t),b(!0)},className:"inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 w-full md:w-auto text-center",children:"Pay Now"})]})]})},t.appointment_id))}),s&&e.jsx(W,{isOpen:s,onClose:()=>b(!1),appointmentDetails:g,onSubmit:()=>x()})]})};export{R as default};
